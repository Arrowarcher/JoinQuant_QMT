# ç§»åŠ¨å¹³å‡çº¿è®¡ç®—è¯¦è§£

## ğŸ¯ é—®é¢˜ï¼šä¸ºä»€ä¹ˆ `hist_data['close'][-5:].mean()` å¯ä»¥ç®—å‡º5æ—¥å‡çº¿ï¼Ÿ

è®©æˆ‘ä»¬é€æ­¥åˆ†è§£è¿™ä¸ªä»£ç ï¼Œå½»åº•ç†è§£ç§»åŠ¨å¹³å‡çº¿çš„è®¡ç®—åŸç†ã€‚

## ğŸ“Š æ•°æ®ç»“æ„ç†è§£

### 1. `hist_data` æ˜¯ä»€ä¹ˆï¼Ÿ
```python
# å‡è®¾æˆ‘ä»¬è·å–äº†10å¤©çš„å†å²æ•°æ®
hist_data = get_price('000001.XSHE', count=10, frequency='daily', fields=['close'])
print(hist_data)
```

è¾“å‡ºç±»ä¼¼è¿™æ ·ï¼š
```
            close
2024-01-01  10.50
2024-01-02  10.80
2024-01-03  10.60
2024-01-04  11.20
2024-01-05  11.50
2024-01-06  11.30
2024-01-07  11.80
2024-01-08  12.00
2024-01-09  11.90
2024-01-10  12.20  â† æœ€æ–°çš„æ•°æ®
```

### 2. `hist_data['close']` æ˜¯ä»€ä¹ˆï¼Ÿ
```python
close_prices = hist_data['close']
print(close_prices)
print(type(close_prices))
```

è¾“å‡ºï¼š
```
2024-01-01    10.50
2024-01-02    10.80
2024-01-03    10.60
2024-01-04    11.20
2024-01-05    11.50
2024-01-06    11.30
2024-01-07    11.80
2024-01-08    12.00
2024-01-09    11.90
2024-01-10    12.20
Name: close, dtype: float64

<class 'pandas.core.series.Series'>
```

è¿™æ˜¯ä¸€ä¸ª **pandas Series**ï¼ŒåŒ…å«äº†æŒ‰æ—¶é—´æ’åºçš„æ”¶ç›˜ä»·æ•°æ®ã€‚

## ğŸ” åˆ‡ç‰‡æ“ä½œè¯¦è§£

### 3. `[-5:]` æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

è¿™æ˜¯Pythonçš„**åˆ‡ç‰‡æ“ä½œ**ï¼Œè®©æˆ‘ä»¬è¯¦ç»†ç†è§£ï¼š

```python
# åŸå§‹æ•°æ®ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰
close_prices = [10.50, 10.80, 10.60, 11.20, 11.50, 11.30, 11.80, 12.00, 11.90, 12.20]
#               ç´¢å¼•: 0     1     2     3     4     5     6     7     8     9

# [-5:] è¡¨ç¤ºä»å€’æ•°ç¬¬5ä¸ªå…ƒç´ å¼€å§‹ï¼Œä¸€ç›´åˆ°æœ€å
last_5_prices = close_prices[-5:]
print(last_5_prices)
# è¾“å‡º: [11.30, 11.80, 12.00, 11.90, 12.20]
```

**è´Ÿæ•°ç´¢å¼•è§£é‡Š**ï¼š
- `-1` è¡¨ç¤ºæœ€åä¸€ä¸ªå…ƒç´ ï¼ˆæœ€æ–°ä»·æ ¼ï¼‰
- `-2` è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ 
- `-5` è¡¨ç¤ºå€’æ•°ç¬¬äº”ä¸ªå…ƒç´ 
- `[-5:]` è¡¨ç¤ºä»å€’æ•°ç¬¬äº”ä¸ªå¼€å§‹åˆ°æœ€å

### 4. ä¸ºä»€ä¹ˆè¦å–æœ€å5å¤©ï¼Ÿ

ç§»åŠ¨å¹³å‡çº¿çš„å®šä¹‰ï¼š**æŸä¸ªæ—¶é—´ç‚¹çš„Næ—¥ç§»åŠ¨å¹³å‡çº¿ = è¯¥æ—¶é—´ç‚¹å¾€å‰Nå¤©çš„ä»·æ ¼å¹³å‡å€¼**

```
æ—¥æœŸ        æ”¶ç›˜ä»·    5æ—¥å‡çº¿è®¡ç®—
01-06      11.30     (10.80+10.60+11.20+11.50+11.30)/5 = 11.08
01-07      11.80     (10.60+11.20+11.50+11.30+11.80)/5 = 11.28  
01-08      12.00     (11.20+11.50+11.30+11.80+12.00)/5 = 11.56
01-09      11.90     (11.50+11.30+11.80+12.00+11.90)/5 = 11.70
01-10      12.20     (11.30+11.80+12.00+11.90+12.20)/5 = 11.84 â† å½“å‰5æ—¥å‡çº¿
```

æ‰€ä»¥ï¼Œå½“å‰æ—¶é—´ç‚¹çš„5æ—¥å‡çº¿ = æœ€è¿‘5å¤©çš„æ”¶ç›˜ä»·å¹³å‡å€¼

## ğŸ’¡ `.mean()` æ–¹æ³•

### 5. `.mean()` è®¡ç®—å¹³å‡å€¼

```python
last_5_prices = [11.30, 11.80, 12.00, 11.90, 12.20]
average = sum(last_5_prices) / len(last_5_prices)
print(average)  # 11.84

# pandasçš„mean()æ–¹æ³•åšçš„æ˜¯åŒæ ·çš„äº‹æƒ…
import pandas as pd
series = pd.Series(last_5_prices)
print(series.mean())  # 11.84
```

## ğŸ”¬ å®Œæ•´ä»£ç åˆ†è§£

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥æ¼”ç¤ºï¼š

```python
# æ­¥éª¤1ï¼šè·å–å†å²æ•°æ®
hist_data = get_price('000001.XSHE', count=10, frequency='daily', fields=['close'])
print("å†å²æ•°æ®ï¼š")
print(hist_data)

# æ­¥éª¤2ï¼šæå–æ”¶ç›˜ä»·åˆ—
close_prices = hist_data['close']
print("\næ”¶ç›˜ä»·åºåˆ—ï¼š")
print(close_prices)

# æ­¥éª¤3ï¼šè·å–æœ€å5å¤©çš„æ•°æ®
last_5_days = close_prices[-5:]
print("\næœ€å5å¤©æ”¶ç›˜ä»·ï¼š")
print(last_5_days)
print("å…·ä½“æ•°å€¼ï¼š", last_5_days.tolist())

# æ­¥éª¤4ï¼šè®¡ç®—å¹³å‡å€¼
ma5 = last_5_days.mean()
print(f"\n5æ—¥å‡çº¿ï¼š{ma5:.2f}")

# éªŒè¯è®¡ç®—
manual_calculation = sum(last_5_days) / len(last_5_days)
print(f"æ‰‹åŠ¨è®¡ç®—éªŒè¯ï¼š{manual_calculation:.2f}")
```

## ğŸ“ˆ ä¸åŒå‘¨æœŸçš„ç§»åŠ¨å¹³å‡çº¿

```python
# è·å–è¶³å¤Ÿçš„å†å²æ•°æ®
hist_data = get_price('000001.XSHE', count=30, frequency='daily', fields=['close'])
close_prices = hist_data['close']

# è®¡ç®—ä¸åŒå‘¨æœŸçš„ç§»åŠ¨å¹³å‡çº¿
ma5 = close_prices[-5:].mean()    # 5æ—¥å‡çº¿
ma10 = close_prices[-10:].mean()  # 10æ—¥å‡çº¿
ma20 = close_prices[-20:].mean()  # 20æ—¥å‡çº¿

print(f"5æ—¥å‡çº¿ï¼š{ma5:.2f}")
print(f"10æ—¥å‡çº¿ï¼š{ma10:.2f}")
print(f"20æ—¥å‡çº¿ï¼š{ma20:.2f}")

# ä¸€èˆ¬è§„å¾‹ï¼šçŸ­æœŸå‡çº¿æ›´æ¥è¿‘å½“å‰ä»·æ ¼ï¼Œé•¿æœŸå‡çº¿æ›´å¹³æ»‘
current_price = close_prices.iloc[-1]
print(f"å½“å‰ä»·æ ¼ï¼š{current_price:.2f}")
```

## ğŸ”„ pandasçš„rolling()æ–¹æ³•

è™½ç„¶ `[-5:].mean()` å¯ä»¥è®¡ç®—å½“å‰çš„5æ—¥å‡çº¿ï¼Œä½†å¦‚æœè¦è®¡ç®—**æ¯ä¸€å¤©çš„5æ—¥å‡çº¿**ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨pandasçš„ `rolling()` æ–¹æ³•ï¼š

```python
# è®¡ç®—æ¯ä¸€å¤©çš„5æ—¥å‡çº¿
hist_data = get_price('000001.XSHE', count=30, frequency='daily', fields=['close'])
close_prices = hist_data['close']

# ä½¿ç”¨rollingæ–¹æ³•è®¡ç®—ç§»åŠ¨å¹³å‡çº¿
ma5_series = close_prices.rolling(window=5).mean()
print("æ¯å¤©çš„5æ—¥å‡çº¿ï¼š")
print(ma5_series.tail(10))  # æ˜¾ç¤ºæœ€å10å¤©çš„5æ—¥å‡çº¿

# è·å–æœ€æ–°çš„5æ—¥å‡çº¿ï¼ˆä¸¤ç§æ–¹æ³•ç»“æœç›¸åŒï¼‰
latest_ma5_method1 = close_prices[-5:].mean()          # æ–¹æ³•1
latest_ma5_method2 = ma5_series.iloc[-1]               # æ–¹æ³•2

print(f"\næ–¹æ³•1ç»“æœï¼š{latest_ma5_method1:.2f}")
print(f"æ–¹æ³•2ç»“æœï¼š{latest_ma5_method2:.2f}")
print(f"ç»“æœæ˜¯å¦ç›¸åŒï¼š{abs(latest_ma5_method1 - latest_ma5_method2) < 0.001}")
```

## ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹

åœ¨èšå®½ç­–ç•¥ä¸­çš„å…¸å‹ç”¨æ³•ï¼š

```python
def handle_data(context, data):
    stock = '000001.XSHE'
    
    # è·å–è¶³å¤Ÿçš„å†å²æ•°æ®
    hist_data = attribute_history(stock, 30, '1d', ['close'])
    
    # è®¡ç®—ç§»åŠ¨å¹³å‡çº¿
    ma5 = hist_data['close'][-5:].mean()     # å½“å‰5æ—¥å‡çº¿
    ma20 = hist_data['close'][-20:].mean()   # å½“å‰20æ—¥å‡çº¿
    
    # è®¡ç®—å‰ä¸€å¤©çš„ç§»åŠ¨å¹³å‡çº¿ï¼ˆç”¨äºåˆ¤æ–­é‡‘å‰æ­»å‰ï¼‰
    ma5_prev = hist_data['close'][-6:-1].mean()   # å‰ä¸€å¤©çš„5æ—¥å‡çº¿
    ma20_prev = hist_data['close'][-21:-1].mean() # å‰ä¸€å¤©çš„20æ—¥å‡çº¿
    
    # åˆ¤æ–­é‡‘å‰ï¼ˆçŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿ï¼‰
    if ma5 > ma20 and ma5_prev <= ma20_prev:
        log.info(f"é‡‘å‰ä¿¡å·ï¼ma5={ma5:.2f}, ma20={ma20:.2f}")
        # è®¡ç®—ç›®æ ‡è‚¡æ•°ï¼ˆ100è‚¡çš„æ•´æ•°å€ï¼‰
        target_shares = int(context.portfolio.total_value * 0.5 / current_price / 100) * 100
        if target_shares >= 100:
            order_target(stock, target_shares)  # ä¹°å…¥
    
    # åˆ¤æ–­æ­»å‰ï¼ˆçŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿ï¼‰
    elif ma5 < ma20 and ma5_prev >= ma20_prev:
        log.info(f"æ­»å‰ä¿¡å·ï¼ma5={ma5:.2f}, ma20={ma20:.2f}")
        order_target(stock, 0)    # å–å‡º
```

## ğŸ“š æ€»ç»“

**`hist_data['close'][-5:].mean()` èƒ½è®¡ç®—5æ—¥å‡çº¿çš„åŸå› ï¼š**

1. **`hist_data['close']`** - è·å–æŒ‰æ—¶é—´æ’åºçš„æ”¶ç›˜ä»·åºåˆ—
2. **`[-5:]`** - å–æœ€å5ä¸ªæ•°æ®ï¼ˆæœ€è¿‘5å¤©ï¼‰
3. **`.mean()`** - è®¡ç®—è¿™5ä¸ªæ•°æ®çš„å¹³å‡å€¼

è¿™å°±æ˜¯**ç§»åŠ¨å¹³å‡çº¿çš„å®šä¹‰**ï¼šæŸä¸ªæ—¶é—´ç‚¹å¾€å‰Nå¤©çš„ä»·æ ¼å¹³å‡å€¼ã€‚

**å…³é”®ç†è§£ç‚¹ï¼š**
- æ•°æ®æ˜¯æŒ‰æ—¶é—´æ’åºçš„
- è´Ÿæ•°ç´¢å¼•ä»åå¾€å‰æ•°
- ç§»åŠ¨å¹³å‡çº¿æ°¸è¿œåŸºäº**å†å²æ•°æ®**è®¡ç®—
- æœ€æ–°çš„ç§»åŠ¨å¹³å‡çº¿ä½¿ç”¨**æœ€è¿‘Nå¤©**çš„æ•°æ®

è¿™ç§è®¡ç®—æ–¹æ³•ç®€å•ç›´è§‚ï¼Œæ˜¯é‡åŒ–äº¤æ˜“ä¸­æœ€å¸¸ç”¨çš„æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ–¹å¼ï¼
