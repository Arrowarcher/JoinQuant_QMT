# 中小板机构信号策略分析

## 策略核心逻辑

### 1. 策略概述
这是一个基于中小板股票的小市值+机构建仓信号策略，结合了基本面筛选、技术面确认和机构建仓信号识别。

### 2. 核心筛选流程
策略采用**四层筛选机制**：

#### 第一层：基础筛选（小市值策略）
- **股票池**：中小板指数（399101.XSHE）
- **筛选逻辑**：
  - 按流通市值升序排列，选择市值最小的股票
  - 候选股票数量 = 目标持仓数量 × 3倍（默认9只）
- **风险过滤**：
  - 排除ST股票
  - 排除停牌股票
  - 排除涨停股票（除非已持仓）
  - 排除跌停股票（除非已持仓）

#### 第二层：机构建仓信号筛选
- **数据来源**：最近5个交易日的历史数据
- **核心指标**：
  - **成交量比率**：当日成交量 / 5日平均成交量
  - **价格变化率**：(当日收盘价 - 5日前收盘价) / 5日前收盘价
  - **连续上涨天数**：统计连续上涨的交易日数

- **评分系统**（权重分配）：
  - 成交量评分：40%（温和放量1.1-3.0倍得满分）
  - 价格变化评分：40%（稳步上涨0.5%-12%得满分）
  - 连续上涨评分：20%（连续2天以上上涨得满分）

- **备选方案**：当机构信号筛选无结果时，直接选择市值最小的股票

#### 第三层：技术面确认（当前已禁用）
- **MA条件**：当前价格 > 5日均线
- **注意**：配置中`technical_confirmation.enabled = False`，此层筛选被跳过

#### 第四层：最终选股
- 限制最终持仓数量为3只股票
- 按评分排序选择前3只

### 3. 策略特点
- **混合策略**：结合小市值策略和机构建仓信号
- **评分机制**：使用灵活的评分系统而非严格的门槛条件
- **备选方案**：确保策略的鲁棒性
- **风险控制**：多重过滤机制避免高风险股票

## 策略买入卖出逻辑

### 买入逻辑

#### 1. 选股触发条件
- **运行频率**：每日14:30执行
- **触发条件**：通过四层筛选机制

#### 2. 买入执行逻辑
```python
# 核心买入逻辑
def open_position(context, security, value):
    # 1. 计算5日均线
    MA_value = close_prices[-5:].mean()
    
    # 2. 获取当前价格
    now_price = current_bars['close'][-1]
    
    # 3. 技术面确认：当前价必须站上5日均线
    if now_price < MA_value:
        return False  # 不买入
    
    # 4. 执行买入订单
    order = order_target_value(security, value)
```

#### 3. 仓位分配
- **等权重分配**：每只股票分配相等资金
- **资金计算**：可用现金 / (目标持仓数 - 当前持仓数)
- **最大持仓**：3只股票

### 卖出逻辑

#### 1. 卖出触发条件
- **调仓逻辑**：每日14:30执行调仓
- **卖出条件**：股票不在新的目标持仓列表中

#### 2. 卖出执行逻辑
```python
# 核心卖出逻辑
def close_position(context, position):
    # 1. 获取股票代码
    security = position.security
    
    # 2. 执行卖出订单（目标仓位为0）
    order = order_target_value(security, 0)
    
    # 3. 确认成交状态
    if order.status == OrderStatus.held and order.filled == order.amount:
        return True
```

#### 3. 调仓机制
- **完全调仓**：每日重新选股，卖出不在目标列表中的股票
- **持仓保持**：已在目标列表中的股票继续持有
- **新开仓位**：买入新的目标股票

### 风险控制机制

#### 1. 交易成本
- **开仓佣金**：0.03%
- **平仓佣金**：0.03%
- **印花税**：0.1%
- **最低佣金**：5元

#### 2. 持仓限制
- **最大持仓数**：3只股票
- **单股最大仓位**：35%
- **单股最小仓位**：25%

#### 3. 数据安全
- **避免未来数据**：`set_option("avoid_future_data", True)`
- **真实价格模式**：`set_option('use_real_price', True)`

## 策略优势与风险

### 优势
1. **多重筛选**：基本面+技术面+机构信号三重保障
2. **灵活评分**：使用评分系统而非严格门槛，提高选股灵活性
3. **备选机制**：确保策略在极端情况下仍能运行
4. **风险控制**：多重过滤机制避免高风险股票

### 风险
1. **技术面确认被禁用**：当前配置跳过了MA确认环节
2. **完全调仓**：每日重新选股可能导致频繁交易
3. **小市值风险**：专注小市值股票可能面临流动性风险
4. **机构信号主观性**：机构建仓信号的识别可能存在误判

### 建议优化方向
1. **启用技术面确认**：将`technical_confirmation.enabled`设为`True`
2. **优化调仓频率**：考虑降低调仓频率以减少交易成本
3. **增加止损机制**：设置个股止损条件
4. **动态仓位管理**：根据市场情况调整仓位大小
