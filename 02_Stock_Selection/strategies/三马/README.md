# 三马V9.4多策略量化投资框架

## 📋 策略概述

**三马V9.4** 是一个经过9个版本迭代优化的多策略量化投资框架，由Cibo开发。该策略采用"三驾马车"的核心理念，通过多策略组合分散风险，追求长期稳定收益。

### 🎯 核心策略组合
- **策略1：小市值策略** - 捕捉小盘股成长机会
- **策略2：ETF反弹策略** - 利用ETF短期反弹获利  
- **策略3：ETF轮动策略** - 基于动量的ETF轮动投资
- **策略4：白马攻防策略** - 市场温度择时的价值投资

## ⚡ 策略核心机制快速理解

### 🛡️ 风险控制机制
1. **大盘顶背离检测**：当市场出现顶部信号时，自动清仓小市值股票，保留涨停股
2. **换手检测**：识别主力出货信号，及时止损异常放量股票
3. **日内止损**：ETF单日跌幅超过3%时立即清仓
4. **防御检测**：通过市场宽度指标判断系统性风险

### 📊 选股和投资逻辑
1. **小市值选股**：基本面筛选(ROE>15%) + 行业分散 + 价格控制(≤20元)
2. **ETF轮动**：动量计算 + RSRS择时 + 成交量过滤
3. **ETF反弹**：捕捉短期反弹机会，持仓2-5天
4. **白马攻防**：根据市场温度调整投资风格

### 🎯 策略优势
- **多策略分散**：四个独立策略，降低单一策略失效风险
- **智能择时**：通过技术指标提前识别市场风险
- **严格止损**：多层次止损机制，控制最大回撤
- **实盘优化**：经过9个版本迭代，代码稳定可靠


## 🔧 实盘启动指南

### 1. **启用实盘依赖**

在策略文件开头取消注释：
```python
# 修改前
# from nredistrade import *  # 导入实盘依赖

# 修改后
from nredistrade import *  # 导入实盘依赖
```

### 2. **启用实盘连接**

在`initialize`函数中取消注释：
```python
def initialize(context):
    set_backtest()  # 设置回测条件
    set_params(context)  # 设置参数
    setup_redis_trade(context, 'strategy1')  # 设置实盘 - 取消注释这行
```

### 3. **配置策略组合**

推荐实盘配置：
```python
# 实盘推荐配置（小市值40% + ETF反弹20% + ETF轮动40%）
g.portfolio_value_proportion = [0.4, 0.2, 0.4, 0]  # 关闭白马策略
```

其他可选配置：
```python
# 保守配置（仅小市值+ETF轮动）
g.portfolio_value_proportion = [0.5, 0, 0.5, 0]

# 激进配置（包含白马策略）
g.portfolio_value_proportion = [0.4, 0.1, 0.3, 0.2]
```

### 4. **风险控制开关**

确保以下风险控制开关已启用：
```python
# 大盘择时保护
g.DBL_control = True              # 大盘顶背离检测
g.ETF_DBL_control = True          # ETF独立顶背离检测

# 止损保护
g.run_stoploss = True             # 止损功能
g.enable_stop_loss_by_cur_day = True  # 日内止损

# 换手检测
g.huanshou_check = True           # 放量换手检测

# 可选：防御检测（增加计算复杂度）
g.check_defense = False           # 成交额宽度防御检测
```

### 6. **资金配置**

策略会根据配置自动调整初始资金：
```python
# 包含小市值策略时使用50万初始资金
g.starting_cash = 500000 if 1 in g.portfolio_value_proportion else 200000
```

## 📊 策略参数说明

### 核心参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `g.portfolio_value_proportion` | `[0.4, 0.2, 0.4, 0]` | 策略资金配比 |
| `g.starting_cash` | `500000` | 初始资金 |
| `g.stoploss_limit` | `0.12` | 止损线（12%） |
| `g.xsz_stock_num` | `5` | 小市值持股数量 |
| `g.min_mv` | `5` | 最小市值（亿） |
| `g.max_mv` | `50` | 最大市值（亿） |

### 风险控制参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `g.DBL_control` | `True` | 大盘顶背离检测 |
| `g.run_stoploss` | `True` | 止损功能 |
| `g.huanshou_check` | `True` | 换手检测 |
| `g.enable_stop_loss_by_cur_day` | `True` | 日内止损 |

## 🎯 适用场景

### ✅ 适合投资者
- **风险承受能力中等**：策略有完善止损机制
- **追求长期收益**：多策略组合适合长期持有
- **希望分散投资**：四个子策略覆盖不同投资风格

### ⚠️ 注意事项
- **白马策略谨慎使用**：作者建议实盘时关闭白马策略
- **ETF反弹策略限制**：仅适用于2023年9月后的数据
- **需要实盘支持**：建议使用支持实盘交易的平台

## 🔧 核心功能详解

### 1. **大盘顶背离检测 (g.DBL_control)**
**作用**：通过MACD指标提前识别市场顶部，规避系统性风险

**工作原理**：
- 检测价格创新高但MACD指标走弱的情况
- 当检测到顶背离信号时，暂停小市值策略调仓
- 清仓非涨停股票，保留涨停股（可能延续强势）

**实际效果**：
- 在2018-2025年历史数据中，成功规避了多次系统性下跌
- 减少策略在熊市中的损失
- 提高策略的夏普比率

### 2. **换手检测 (g.huanshou_check)**
**作用**：识别异常放量，及时止损避免进一步损失

**工作原理**：
- 计算实时换手率与20日平均换手率的比值
- 当比值超过2倍且换手率>10%时，判定为异常放量
- 自动卖出异常放量的股票

**实际效果**：
- 避免在主力出货时继续持有
- 减少因消息面利空导致的损失
- 提高资金使用效率

### 3. **ETF轮动动量计算**
**作用**：基于技术指标选择最优ETF进行轮动投资

**工作原理**：
- 使用25天加权线性回归计算年化收益率
- 结合RSRS指标判断趋势强度
- 过滤近3日跌幅超过5%的ETF
- 排除异常放量的ETF

**实际效果**：
- 捕捉ETF的短期趋势机会
- 避免在下跌趋势中持有ETF
- 提高ETF投资的胜率

### 4. **日内止损 (g.enable_stop_loss_by_cur_day)**
**作用**：防止ETF在单日出现大幅亏损

**工作原理**：
- 监控ETF当日开盘价与当前价的跌幅
- 当跌幅超过3%时，立即清仓
- 避免单日大幅亏损影响整体收益

**实际效果**：
- 控制单日最大亏损
- 提高策略的稳定性
- 减少极端行情的影响

### 5. **小市值选股算法**
**作用**：通过多维度筛选找到优质小盘股

**筛选条件**：
- **基本面**：ROE>15%, ROA>10%, 净利润>0
- **市值区间**：5-50亿，避免过小或过大
- **行业分散**：每个行业最多1只股票
- **价格控制**：股价上限20元

**实际效果**：
- 捕捉小盘股成长机会
- 通过行业分散降低风险
- 控制单股风险敞口

### 6. **成交额宽度防御检测 (g.check_defense)**
**作用**：通过市场宽度指标判断整体市场风险，提前规避系统性风险

**工作原理**：
- 计算各行业站上20日均线的股票比例
- 监控成交额排名前20%的股票表现
- 结合涨跌比和趋势指标综合判断
- 当检测到防御信号时，清仓小市值股票

**实际效果**：
- 在2018-2025年历史数据中，成功识别了多次市场风险
- 减少策略在系统性风险中的损失
- 提高策略的风险调整收益

### 7. **ETF反弹策略**
**作用**：捕捉ETF短期反弹机会，获取波段收益

**工作原理**：
- 监控ETF开盘价相比近3日最高价的跌幅
- 当跌幅超过2%且当前价相比开盘价上涨1%时买入
- 持仓2-5天，根据市场表现灵活调整

**实际效果**：
- 捕捉ETF的短期反弹机会
- 通过多ETF轮换提高成功率
- 在震荡市中获取稳定收益

---

**总结**：三马V9.4是一个经过充分验证的多策略量化投资框架，具有完善的风险控制体系、智能的选股算法和实盘优化设计。适合追求长期稳定收益的量化投资者使用。
