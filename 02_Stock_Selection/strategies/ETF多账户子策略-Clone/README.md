# ETF多账户子策略分析

## 什么是多账户子策略？

多账户子策略是一种资金管理技术，将总资金按比例分配给多个独立的子账户，每个子账户运行不同的投资策略。在这个策略中：

### 资金分配
- **全球选基策略**：分配90%的资金（子账户0）
- **动量轮动策略**：分配10%的资金（子账户1）

### 技术实现
```python
# 创建子账户配置
subportfolios = [
    SubPortfolioConfig(
        context.portfolio.starting_cash * 0.9,  # 90%资金
        'stock'
    ),
    SubPortfolioConfig(
        context.portfolio.starting_cash * 0.1,  # 10%资金
        'stock'
    )
]
set_subportfolios(subportfolios)
```

### 优势
1. **风险分散**：不同策略独立运行，降低单一策略风险
2. **策略对比**：可以比较不同策略的表现
3. **资金隔离**：每个子账户有独立的资金池
4. **灵活调整**：可以动态调整各策略的资金比例

## 策略核心逻辑

### 1. 全球选基策略（90%资金）

#### 核心思想
基于动量因子轮动，选择表现最好的ETF进行投资。

#### 评分机制
- **年化收益率**：通过线性回归计算价格趋势的年化收益率
- **R²判定系数**：衡量价格趋势的稳定性和可靠性
- **综合得分**：年化收益率 × R²

#### 技术特点
- **动态调整**：根据ATR（平均真实波幅）动态调整回看天数
- **权重加权**：近期数据权重更高，更关注最新趋势
- **风险过滤**：过滤近3日跌幅超过5%的ETF

### 2. 动量轮动策略（10%资金）

#### 核心思想
基于动量因子选择ETF，并使用EPO（期望投资组合优化）进行权重分配。

#### 评分机制
- **动量评分**：基于价格趋势的年化收益率和R²
- **优化权重**：使用EPO算法计算最优权重分配

#### 技术特点
- **月度调仓**：每月第一个交易日执行调仓
- **权重优化**：使用协方差矩阵和信号进行权重优化
- **风险控制**：通过协方差收缩降低估计误差

## 策略买入卖出逻辑

### 全球选基策略交易逻辑

#### 买入条件
1. **每日评分**：每日14:50执行评分
2. **排名筛选**：选择得分最高的1只ETF
3. **有效性检查**：得分在0-3之间且不为空
4. **趋势确认**：近3日跌幅不超过5%

#### 买入执行
```python
# 计算投资金额
invest_value = subportfolio.available_cash / (target_num - len(current_hold))

# 执行买入
order_target_value(etf, invest_value, pindex=self.subportfolio_index)
```

#### 卖出条件
- 持仓ETF不在新的目标列表中
- 执行完全调仓，卖出所有非目标ETF

### 动量轮动策略交易逻辑

#### 买入条件
1. **月度评分**：每月第一个交易日执行
2. **动量筛选**：选择得分最高的ETF
3. **权重优化**：使用EPO算法计算最优权重
4. **风险控制**：过滤负收益ETF

#### 买入执行
```python
# 获取优化权重
weights = self.run_optimization(target_list, end_date)

# 按权重分配资金
for w in weights:
    if w > 0:
        value = total_value * w
        order_target_value(target_list[index], value, pindex=self.subportfolio_index)
```

#### 卖出条件
- 持仓ETF不在新的目标列表中
- 月度调仓时执行

### 风险控制机制

#### 交易成本控制
- **开仓佣金**：0.02%
- **平仓佣金**：0.02%
- **滑点**：0.1%
- **最低佣金**：1元

#### 数据安全
- **避免未来数据**：`set_option("avoid_future_data", True)`
- **真实价格模式**：`set_option('use_real_price', True)`

#### 持仓限制
- **全球选基策略**：最多持有1只ETF
- **动量轮动策略**：最多持有1只ETF（可扩展）

## 策略优势

1. **双重策略**：结合全球选基和动量轮动，分散风险
2. **动态调整**：根据市场波动性动态调整参数
3. **风险控制**：多重过滤机制，降低风险
4. **资金管理**：合理的资金分配，主策略占主导地位

## 策略风险

1. **集中持仓**：每个子策略只持有1只ETF，集中度较高
2. **趋势依赖**：策略依赖价格趋势，在震荡市中可能表现不佳
3. **调仓频率**：全球选基策略每日调仓，可能增加交易成本
4. **参数敏感**：策略对参数设置较为敏感，需要定期优化
